---
title: "Origin-destination data with stplanr"
output: rmarkdown::html_vignette
author: "Robin Lovelace"
vignette: >
  %\VignetteIndexEntry{stplanr vignette 2: origin-destination data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography:
 - references.bib
 - stplanr-citation.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE
)
```

# Introduction: what is OD data?

Origin-destination (OD) data is data that has not just one geographic location, but two.
As the name suggests, OD data represents movement through geographic space, from an origin (O) to a destination (D).
Despite the rather dull name, OD datasets are a vital part of the modern world, underpinning the transport models that influence current *and future* systems.
If you, like many others, are frustrated by the car dominated nature of most cities, OD datasets should be of great interest: they underlie the car-centric transport models that inform and helped justify the vast expansion of highways that happened in the 20^th^ Century [@boyce_forecasting_2015].

If you are under any illusion that this healthy outcome of 20^th^ Century transport planning, consider this: roads are now the largest cause of death and injury for young people worldwide, killing and maiming more than more than 1 million and 10 million people each year according to data from the [World Health Organization](https://www.who.int/violence_injury_prevention/road_safety_status/2018/en/).
Even ignoring other problems such as air pollution, an obesity crisis driven by physical inactivity and climate change, it is clear that current transport systems, and the models that have helped to design them, are unsustainable.
There are other reasons why transport data analysis is important, as outlined in the 'stplanr paper' [@lovelace_stplanr_2018].

The purpose of this paper is to provide an introduction to OD paper, with examples based on data and functions from the stplanr package.
OD data can be accessed from a range of sources (we will see code that downloads millions of OD pairs later in this vignette).
Generally you will need to do some 'data carpentry' before the OD data is 'clean' and ready for analysis.
This vignette will not cover cleaning OD, we assume you know R and come with clean (if not 'tidy') data!

In simple terms OD data looks like this:


```{r setup, message=FALSE}
library(stplanr)
library(dplyr)
od = pct::wight_od %>% 
  select(-matches("rail|name|moto|car|tax|home")) %>% 
  top_n(n = 5, wt = all)
class(od)
od
```

The next section discusses this, and other, representations of OD data.

# Representations of OD data

Like all datasets the object `od`, created in the preceding code chunk, comes from a specific context: the 2011 [UK Census](https://census.ukdataservice.ac.uk/media/50966/2011_england_household.pdf) questions:

- In your main job, what is the address of your workplace?
- How do you usually travel to work (for the longest part, by distance, of your usual journey to work)?
  - Work mainly at or from home
  - Underground, metro, light rail, tram
  - Train
  - ...
  
The object `od` contains aggregated answers to these question, counting how many people travel from each origin zone to each destination zone, in the 'long' form, where each row is an 'od pair'.
OD data can also bee represented as an 'OD matrix', as demonstrated in the next subsection.


The long form of  below with the **stplanr** function `od_to_odmatrix()`:

```{r}
od_matrix = od_to_odmatrix(od[1:3])
class(od_matrix)
od_matrix
```

Instead of creating a new column for each *OD pair*, this matrix representation creates a new row for each *zone of origin*.
It is a simpler data structure, containing only counts, and was popular in the origin origins of transport planning: 'OD matrix' is still sometimes used informally to any OD data.
However, I recommend using the long OD pair representation: OD matrices become unwieldy for large OD datasets, which are likely to be sparse, with many NAs.
Furthermore, multiple lists of OD matrices or 'OD arrays' must be created to represent multiple attributes.
This is demonstrated in the code chunk below, which represents travel between OD pairs by all modes and by bike:

```{r}
lapply(c("all", "bicycle"), function(x) od_to_odmatrix(od[c("geo_code1", "geo_code2", x)]))
```

The function `odmatrix_to_od()` can help get your data into the more convenient long form:

```{r}
odmatrix_to_od(od_matrix)
```

Another common (and sometimes problematic) feature of OD data is 'intra-zonal flows'.
These are trips that start and end in the same zone.
It is often useful to separate intra-zonal and inter-zonal flows at the outset, as demonstrated below:


```{r}
(od_inter = od %>% filter(geo_code1 != geo_code2))
(od_intra = od %>% filter(geo_code1 == geo_code2))
```

## Origin destination matrices

## Desire lines

The previous two representations of OD data are 'implicitly geographic': their coordinates are not contained in the data, but associated with another data object, typically a zone or a zone centroid.
This is clearly problematic because it makes OD data less modular and self standing.
A useful way of representing OD data that overcomes this issue is `desire_line` data: geographic lines between origin and destination, with information on flow levels between the two.

This is represented in the file `lines_cars.Rds`, representing the top 20,000 desire lines at the MSOA-MSOA level in England and Wales by the number of car km used for travel to work, which can be downloaded, read-in and plotted as follows:


```{r, out.width="100%", warning=FALSE, eval=FALSE}
u = "https://github.com/ropensci/stplanr/releases/download/0.2.9/lines_cars.Rds"
f = file.path(tempdir(), "lines_cars.Rds")
download.file(u, f)
lines_cars = readRDS(f)
plot(lines_cars["car_km"], lwd = lines_cars$car_km / 1000)
```

Based on the estimate of the average energy use per km being 2.5 MJ, and that these return trips are made on average 200 times per year, with a circuity of 1.3, we can estimate the total energy use of the 'high energy commutes' as follows:

```{r, eval=FALSE}
sum(lines_cars$car_km * 2.5 * 200) / 1e9
```

That represents ~10 petajoules (PJ), only for the top 20,000 most energy intensive commutes.
That may seem like a lot, but represents only a fraction of the UK's total energy use of [~200 Mtoe](https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/729451/DUKES_PN.pdf) (8400 PJ).


```{r, echo=FALSE, eval=FALSE}
# out-takes and test code
u = "http://www.rita.dot.gov/bts/sites/rita.dot.gov.bts/files/publications/commodity_flow_survey/2007/zip/origin_destination_files.zip"
f =  file.path(tempdir(), "origin_destination_files.zip")
download.file(u, f)
unzip(f)

# demonstrate bug/feature in sf
library(sf)
m = matrix(c(0, 0,
             1, 0,
             0, 1,
             0, 0), ncol = 2)
p = st_polygon(list(m))

m = matrix(c(0, 0,
             1, 0,
             0, NA,
             0, 0), ncol = 2)
p = st_polygon(list(m))
plot(p)

l = st_linestring(m)
plot(l)
plot(p)
m = matrix(c(0, 0, 0, NA), ncol = 2)
l = st_linestring(m)
plot(l)
```



