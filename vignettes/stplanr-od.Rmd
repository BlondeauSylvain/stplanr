---
title: "Origin-destination data with stplanr"
output: rmarkdown::html_vignette
author: "Robin Lovelace"
vignette: >
  %\VignetteIndexEntry{stplanr vignette 2: origin-destination data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography:
 - references.bib
 - stplanr-citation.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE
)
```

# Introduction: what is OD data?

Origin-destination (OD) data is data that has not just one geographic location, but two.
As the name suggests, OD data represents movement through geographic space, from an origin (O) to a destination (D).
Despite the rather dull name, OD datasets are a vital part of the modern world, underpinning the transport models that influence current *and future* systems.
If you, like many others, are frustrated by the car dominated nature of most cities, OD datasets should be of great interest: they underlie the car-centric transport models that inform and helped justify the vast expansion of highways that happened in the 20^th^ Century [@boyce_forecasting_2015].

If you are under any illusion that this healthy outcome of 20^th^ Century transport planning, consider this: roads are now the largest cause of death and injury for young people worldwide, killing and maiming more than more than 1 million and 10 million people each year according to data from the [World Health Organization](https://www.who.int/violence_injury_prevention/road_safety_status/2018/en/).
Even ignoring other problems such as air pollution, an obesity crisis driven by physical inactivity and climate change, it is clear that current transport systems, and the models that have helped to design them, are unsustainable.
There are other reasons why transport data analysis is important, as outlined in the 'stplanr paper' [@lovelace_stplanr_2018].
The purpose of this vignette is to introduce OD data, with examples based on data and functions from the stplanr package.

# An minimal example OD dataset

OD data can be accessed from a range of sources (we will see code that downloads millions of OD pairs later in this vignette).
Generally you will need to do some 'data carpentry' before the OD data is 'clean' and ready for analysis.
This vignette will not cover cleaning OD, we assume you know R and come with clean (if not 'tidy') data!

In simple terms OD data looks like this:

```{r setup, message=FALSE}
library(stplanr)
library(dplyr)
od = pct::wight_od %>% 
  select(-matches("rail|name|moto|car|tax|home")) %>% 
  top_n(n = 5, wt = all)
class(od)
od
```

<!-- The next section discusses this, and other, representations of OD data. -->

<!-- # Representations of OD data -->

Like all data, the object `od`, created in the preceding code chunk, comes from a specific context: the 2011 [UK Census](https://census.ukdataservice.ac.uk/media/50966/2011_england_household.pdf) questions:

- In your main job, what is the address of your workplace?
- How do you usually travel to work (for the longest part, by distance, of your usual journey to work)?
  - Work mainly at or from home
  - Underground, metro, light rail, tram
  - Train
  - ...
  
The object `od` is a data frame containing aggregated answers to these questions (see `?pct::get_od()` for details).
It is *implicitly geographic*: the first two columns refer to geographic entities but do not contain coordinates themselves (OD coordinates are covered below).
Other columns contain attributes associated with each OD pair, typically counting how many people travel by mode of transport.
OD data can be represented in a number of ways, as outlined in the next sections.

# Origin-destination pairs (long form)

The most useful way of representing OD data is the 'long' data frame format described above.
This is increasingly the format used by official statistical agencies, including the UK's Office for National Statistics (ONS), who provide origin destination data as a `.csv` file.
Typically, the first column is the zone code of origin and the second column is the zone code of the destination, as is the case with the object `od`:

```{r}
od[1:2]
```

`geo_code1` refers to the origin, `geo_code2` refers to the destination.

Data in this form usually has at least one other colum, representing the amount of travel between the zones.
Additional columns represent addition attributes, e.g. a breakdown of flow by time, mode of travel, type of person, or trip purpose.
The `od` dataset contains column names representing mode of travel (train, bus, bicycle etc):

```{r}
names(od[-(1:2)])
```

These 'mode' columns contain integers.
While additional columns can contain characters, dates and other data types, taking advantage of the flexibility of data frames.

# Origin destination matrices

The 'OD matrix' representation of OD data represents each attribute column in the long form as a separate matrix.
Instead of rows representing OD pairs, rows represent all travel from each origin to all destinations (represented as columns).
The **stplanr** function `od_to_odmatrix()` converts between the 'long' to the 'matrix' form on a per column basis, as illustrated below:

```{r}
od_matrix = od_to_odmatrix(od[1:3])
class(od_matrix)
od_matrix
```

Note that row and column names are now zone codes.
The cell in row 2 and column 1 (`od_matrix[2, 1]`) means that `831` people travel from zone `E02003591` to zone `E02003588`.
It is a simpler data structure, usually only containing only counts, and was popular in 20^th^ Century transport models. 
'OD matrix' is still sometimes used informally to any OD data.

However, I recommend using the long OD pair representation: OD matrices become unwieldy for large OD datasets, which are likely to be sparse, with many NAs.
Furthermore, multiple lists of OD matrices or 'OD arrays' must be created to represent multiple attributes.
This is demonstrated in the code chunk below, which represents travel between OD pairs by all modes and by bike:

```{r}
lapply(c("all", "bicycle"), function(x) od_to_odmatrix(od[c("geo_code1", "geo_code2", x)]))
```

The function `odmatrix_to_od()` converts OD matrices back into the more convenient long form:

```{r}
odmatrix_to_od(od_matrix)
```

# Intra-zonal flows

A common, and sometimes problematic, feature of OD data is 'intra-zonal flows'.
These are trips that start and end in the same zone.
The proportion of travel that is intra-zonal depends largely on the size of the zones used.
It is often useful to separate intra-zonal and inter-zonal flows at the outset, as demonstrated below:

```{r}
(od_inter = od %>% filter(geo_code1 != geo_code2))
(od_intra = od %>% filter(geo_code1 == geo_code2))
```

# Desire lines

The previous representations of OD data are all implicitly geographic: their coordinates are not contained in the data, but associated with another object that *is* geographic, typically a zone or a zone centroid.
This is problematic, meaning that multiple objects or files are required to fully represent the same data.
Desire line representations overcome this issue.
They are geographic lines between origin and destination, with the same attributes as in the 'long' representation.

`od2line()` can convert long form OD data to desire lines.
The second argument is a zone or a centroid dataset that contains 'zone IDs' that match the IDs in the first and second columns of the OD data, as illustrated below:

```{r}
z = pct::wight_centroids
class(z)
l = od2line(flow = od_inter, zones = z)
```

The preceding code chunk created a zones object called `z`, the coordinates of which were used to convert the object `od` into `l`, which are geographic desire lines.
The desire line object is stored in as a geographic simple features object, which has the same number of rows as does the object `od` and one more column:

```{r}
class(l)
nrow(l) - nrow(od)
ncol(l) - ncol(od)
```

The new column is the geometry column, which can be plotted as follows:

```{r}
plot(l$geometry)
```

By default, plotting `l` shows the attributes for each line:

```{r}
plot(l)
```

Because these lines have a coordinate reference system (CRS) inherited from the zones data, they can also be plotted on an interactive map, as follows:

```{r}
library(leaflet)
leaflet() %>% 
  addTiles() %>% 
  addPolygons(data = l)
```

# A larger example

The minimal example dataset we've been using so far is fine for demonstrating the key concepts of OD data.
But for more advanced topic, and to get an idea of what is possible with OD data at a city level, it helps to have a larger dataset.

We will use and example dataset representing commuting in London, accessed as follows (note: these code chunks are not evaluated in the vignette to reduce the package's build times):

```{r, eval=FALSE}
od_all = pct::get_od()
```

```{r, eval=FALSE, echo=FALSE}
readr::write_csv(od_all, "od_all.csv")
saveRDS(od_all, "od_all.Rds")
piggyback::pb_upload("od_all.Rds")
```






# Oneway lines

# Applications

This is represented in the file `lines_cars.Rds`, representing the top 20,000 desire lines at the MSOA-MSOA level in England and Wales by the number of car km used for travel to work, which can be downloaded, read-in and plotted as follows:


```{r, out.width="100%", warning=FALSE, eval=FALSE}
u = "https://github.com/ropensci/stplanr/releases/download/0.2.9/lines_cars.Rds"
f = file.path(tempdir(), "lines_cars.Rds")
download.file(u, f)
lines_cars = readRDS(f)
plot(lines_cars["car_km"], lwd = lines_cars$car_km / 1000)
```

<!-- Based on the estimate of the average energy use per km being 2.5 MJ, and that these return trips are made on average 200 times per year, with a circuity of 1.3, we can estimate the total energy use of the 'high energy commutes' as follows: -->

```{r, eval=FALSE, echo=FALSE}
sum(lines_cars$car_km * 2.5 * 200) / 1e9
```

<!-- That represents ~10 petajoules (PJ), only for the top 20,000 most energy intensive commutes. -->
<!-- That may seem like a lot, but represents only a fraction of the UK's total energy use of [~200 Mtoe](https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/729451/DUKES_PN.pdf) (8400 PJ). -->


```{r, echo=FALSE, eval=FALSE}
# out-takes and test code
u = "http://www.rita.dot.gov/bts/sites/rita.dot.gov.bts/files/publications/commodity_flow_survey/2007/zip/origin_destination_files.zip"
f =  file.path(tempdir(), "origin_destination_files.zip")
download.file(u, f)
unzip(f)

# demonstrate bug/feature in sf
library(sf)
m = matrix(c(0, 0,
             1, 0,
             0, 1,
             0, 0), ncol = 2)
p = st_polygon(list(m))

m = matrix(c(0, 0,
             1, 0,
             0, NA,
             0, 0), ncol = 2)
p = st_polygon(list(m))
plot(p)

l = st_linestring(m)
plot(l)
plot(p)
m = matrix(c(0, 0, 0, NA), ncol = 2)
l = st_linestring(m)
plot(l)
```




```{r, eval=FALSE, echo=FALSE}
remotes::install_github("ITSLeeds/pct")
library(pct)
od_data_all = pct::get_od()
sel_local = 
  od_data_all$geo_code1 %in% cents_sf$geo_code &
  od_data_all$geo_code2 %in% cents_sf$geo_code 
od_data_sample = od_data_all[sel_local, ]
```

```{r, echo=FALSE, eval=FALSE}
usethis::use_data(od_data_sample)
# aim: get top flows by car use multiplied by distance
# subset flows with more than n people driving:
od_cars = od_data_all[od_data_all$car_driver >= 50, ]
cents_ew = pct::get_centroids_ew()
od_cars = od_cars[
  od_cars$geo_code1 %in% cents_ew$msoa11cd &
  od_cars$geo_code2 %in% cents_ew$msoa11cd ,
  ]
desire_lines_cars = od2line(od_cars, cents_ew)
plot(desire_lines_cars[1:999, ])
desire_lines_cars$euclidean_distance_m = as.numeric(sf::st_length(desire_lines_cars)) / 1000
desire_lines_cars$car_km = desire_lines_cars$car_driver * desire_lines_cars$euclidean_distance_m
lines_cars = dplyr::top_n(desire_lines_cars, 20000, car_km)
summary(lines_cars$car_driver)
plot(lines_cars["car_km"])
saveRDS(lines_cars, "lines_cars.Rds")
piggyback::pb_upload("lines_cars.Rds")
```

# References